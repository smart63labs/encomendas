-- =====================================================
-- SCRIPT PARA CRIAR SCHEMA DEDICADO - NOVO PROTOCOLO
-- =====================================================
-- Execute este script como usuário SYSTEM ou DBA

-- 1. CRIAR USUÁRIO/SCHEMA
CREATE USER NOVOPROTOCOLO IDENTIFIED BY "NovoProtocolo2024"
  DEFAULT TABLESPACE USERS
  TEMPORARY TABLESPACE TEMP
  QUOTA UNLIMITED ON USERS;

-- 2. CONCEDER PRIVILÉGIOS BÁSICOS
GRANT CONNECT TO NOVOPROTOCOLO;
GRANT RESOURCE TO NOVOPROTOCOLO;
GRANT CREATE SESSION TO NOVOPROTOCOLO;
GRANT CREATE TABLE TO NOVOPROTOCOLO;
GRANT CREATE SEQUENCE TO NOVOPROTOCOLO;
GRANT CREATE VIEW TO NOVOPROTOCOLO;
GRANT CREATE PROCEDURE TO NOVOPROTOCOLO;
GRANT CREATE TRIGGER TO NOVOPROTOCOLO;

-- 3. PRIVILÉGIOS ADICIONAIS (se necessário)
GRANT CREATE ANY INDEX TO NOVOPROTOCOLO;
GRANT ALTER ANY TABLE TO NOVOPROTOCOLO;
GRANT DROP ANY TABLE TO NOVOPROTOCOLO;

-- =====================================================
-- CONECTAR COMO NOVO USUÁRIO E CRIAR TABELAS
-- =====================================================
-- Conecte-se como NOVOPROTOCOLO e execute os comandos abaixo:

-- TABELA USUARIOS
CREATE TABLE USUARIOS (
    ID NUMBER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    NOME VARCHAR2(100) NOT NULL,
    EMAIL VARCHAR2(100) UNIQUE NOT NULL,
    SENHA VARCHAR2(255) NOT NULL,
    PERFIL VARCHAR2(20) DEFAULT 'USUARIO' CHECK (PERFIL IN ('ADMIN', 'USUARIO', 'OPERADOR')),
    ATIVO NUMBER(1) DEFAULT 1 CHECK (ATIVO IN (0, 1)),
    DATA_CRIACAO TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    DATA_ATUALIZACAO TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- TABELA PROCESSOS
CREATE TABLE PROCESSOS (
    ID NUMBER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    NUMERO_PROCESSO VARCHAR2(50) UNIQUE NOT NULL,
    TITULO VARCHAR2(200) NOT NULL,
    DESCRICAO CLOB,
    STATUS VARCHAR2(20) DEFAULT 'ABERTO' CHECK (STATUS IN ('ABERTO', 'EM_ANDAMENTO', 'CONCLUIDO', 'ARQUIVADO')),
    PRIORIDADE VARCHAR2(10) DEFAULT 'MEDIA' CHECK (PRIORIDADE IN ('BAIXA', 'MEDIA', 'ALTA', 'URGENTE')),
    USUARIO_RESPONSAVEL_ID NUMBER,
    DATA_ABERTURA TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    DATA_PRAZO TIMESTAMP,
    DATA_CONCLUSAO TIMESTAMP,
    OBSERVACOES CLOB,
    CONSTRAINT FK_PROCESSO_USUARIO FOREIGN KEY (USUARIO_RESPONSAVEL_ID) REFERENCES USUARIOS(ID)
);

-- TABELA DOCUMENTOS
CREATE TABLE DOCUMENTOS (
    ID NUMBER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    PROCESSO_ID NUMBER NOT NULL,
    NOME_ARQUIVO VARCHAR2(255) NOT NULL,
    TIPO_DOCUMENTO VARCHAR2(50),
    TAMANHO_ARQUIVO NUMBER,
    CAMINHO_ARQUIVO VARCHAR2(500),
    HASH_ARQUIVO VARCHAR2(64),
    USUARIO_UPLOAD_ID NUMBER,
    DATA_UPLOAD TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    OBSERVACOES VARCHAR2(500),
    CONSTRAINT FK_DOCUMENTO_PROCESSO FOREIGN KEY (PROCESSO_ID) REFERENCES PROCESSOS(ID),
    CONSTRAINT FK_DOCUMENTO_USUARIO FOREIGN KEY (USUARIO_UPLOAD_ID) REFERENCES USUARIOS(ID)
);

-- TABELA TRAMITACOES
CREATE TABLE TRAMITACOES (
    ID NUMBER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    PROCESSO_ID NUMBER NOT NULL,
    USUARIO_ORIGEM_ID NUMBER,
    USUARIO_DESTINO_ID NUMBER,
    ACAO VARCHAR2(50) NOT NULL,
    OBSERVACOES CLOB,
    DATA_TRAMITACAO TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    STATUS_ANTERIOR VARCHAR2(20),
    STATUS_NOVO VARCHAR2(20),
    CONSTRAINT FK_TRAMITACAO_PROCESSO FOREIGN KEY (PROCESSO_ID) REFERENCES PROCESSOS(ID),
    CONSTRAINT FK_TRAMITACAO_ORIGEM FOREIGN KEY (USUARIO_ORIGEM_ID) REFERENCES USUARIOS(ID),
    CONSTRAINT FK_TRAMITACAO_DESTINO FOREIGN KEY (USUARIO_DESTINO_ID) REFERENCES USUARIOS(ID)
);

-- TABELA PRAZOS
CREATE TABLE PRAZOS (
    ID NUMBER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    PROCESSO_ID NUMBER NOT NULL,
    TIPO_PRAZO VARCHAR2(50) NOT NULL,
    DATA_INICIO TIMESTAMP NOT NULL,
    DATA_VENCIMENTO TIMESTAMP NOT NULL,
    DATA_CONCLUSAO TIMESTAMP,
    STATUS VARCHAR2(20) DEFAULT 'PENDENTE' CHECK (STATUS IN ('PENDENTE', 'CUMPRIDO', 'VENCIDO')),
    OBSERVACOES VARCHAR2(500),
    USUARIO_RESPONSAVEL_ID NUMBER,
    CONSTRAINT FK_PRAZO_PROCESSO FOREIGN KEY (PROCESSO_ID) REFERENCES PROCESSOS(ID),
    CONSTRAINT FK_PRAZO_USUARIO FOREIGN KEY (USUARIO_RESPONSAVEL_ID) REFERENCES USUARIOS(ID)
);

-- TABELA ENCOMENDAS
CREATE TABLE ENCOMENDAS (
    ID NUMBER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    PROCESSO_ID NUMBER,
    CODIGO_RASTREAMENTO VARCHAR2(50) UNIQUE,
    DESTINATARIO VARCHAR2(200) NOT NULL,
    ENDERECO CLOB NOT NULL,
    TIPO_ENCOMENDA VARCHAR2(50),
    STATUS VARCHAR2(20) DEFAULT 'PREPARANDO' CHECK (STATUS IN ('PREPARANDO', 'ENVIADO', 'ENTREGUE', 'DEVOLVIDO')),
    DATA_ENVIO TIMESTAMP,
    DATA_ENTREGA TIMESTAMP,
    VALOR_POSTAGEM NUMBER(10,2),
    OBSERVACOES VARCHAR2(500),
    CONSTRAINT FK_ENCOMENDA_PROCESSO FOREIGN KEY (PROCESSO_ID) REFERENCES PROCESSOS(ID)
);

-- =====================================================
-- CRIAR ÍNDICES PARA PERFORMANCE
-- =====================================================
CREATE INDEX IDX_PROCESSOS_STATUS ON PROCESSOS(STATUS);
CREATE INDEX IDX_PROCESSOS_USUARIO ON PROCESSOS(USUARIO_RESPONSAVEL_ID);
CREATE INDEX IDX_DOCUMENTOS_PROCESSO ON DOCUMENTOS(PROCESSO_ID);
CREATE INDEX IDX_TRAMITACOES_PROCESSO ON TRAMITACOES(PROCESSO_ID);
CREATE INDEX IDX_PRAZOS_PROCESSO ON PRAZOS(PROCESSO_ID);
CREATE INDEX IDX_PRAZOS_VENCIMENTO ON PRAZOS(DATA_VENCIMENTO);
CREATE INDEX IDX_ENCOMENDAS_STATUS ON ENCOMENDAS(STATUS);
CREATE INDEX IDX_ENCOMENDAS_RASTREAMENTO ON ENCOMENDAS(CODIGO_RASTREAMENTO);

-- =====================================================
-- INSERIR DADOS INICIAIS
-- =====================================================
-- Usuário administrador padrão (senha: admin123)
INSERT INTO USUARIOS (NOME, EMAIL, SENHA, PERFIL) 
VALUES ('Administrador', 'admin@novoprotocolo.com', '$2b$10$92IXUNpkjO0rOQ5byMi.Ye4oKoEa3Ro9llC/.og/at2.uheWG/igi', 'ADMIN');

-- Confirmar transações
COMMIT;

-- =====================================================
-- VERIFICAR CRIAÇÃO
-- =====================================================
SELECT 'Tabelas criadas com sucesso!' as RESULTADO FROM DUAL;
SELECT table_name FROM user_tables ORDER BY table_name;

-- =====================================================
-- INSTRUÇÕES DE USO
-- =====================================================
/*
1. Execute este script como usuário SYSTEM ou DBA
2. Atualize o arquivo .env com:
   DB_USER=NOVOPROTOCOLO
   DB_PASSWORD=NovoProtocolo2024
3. Reinicie o servidor backend
4. Teste a conexão com /api/database/check-tables

Credenciais do usuário administrador:
- Email: admin@novoprotocolo.com
- Senha: admin123
*/