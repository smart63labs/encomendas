-- ============================================================
-- SCRIPT PARA RECRIAR TABELA SETORES COM ESTRUTURA EXATA
-- ============================================================
-- Data: 10/10/2025
-- Descrição: Remove a tabela atual e recria com a estrutura exata especificada
-- ============================================================

-- Conectar como protocolo_user
-- sqlplus protocolo_user/Anderline49@localhost:1521/FREEPDB1

-- 1. REMOVER A TABELA ATUAL
DROP TABLE SETORES CASCADE CONSTRAINTS;

-- 2. RECRIAR A TABELA COM A ESTRUTURA EXATA ESPECIFICADA
CREATE TABLE SETORES (
    ID NUMBER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    CODIGO_SETOR VARCHAR2(50) NOT NULL,
    NOME_SETOR VARCHAR2(200) NOT NULL,
    ORGAO VARCHAR2(200),
    ATIVO CHAR(1) DEFAULT 'S' CHECK (ATIVO IN ('S', 'N')),
    LOGRADOURO VARCHAR2(200),
    NUMERO VARCHAR2(20),
    COMPLEMENTO VARCHAR2(100),
    BAIRRO VARCHAR2(100),
    CIDADE VARCHAR2(100),
    ESTADO VARCHAR2(2),
    CEP VARCHAR2(10),
    TELEFONE VARCHAR2(20),
    EMAIL VARCHAR2(100),
    DATA_CRIACAO TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    DATA_ATUALIZACAO TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    LATITUDE NUMBER(10,8),
    LONGITUDE NUMBER(11,8)
);

-- 3. CRIAR ÍNDICES PARA PERFORMANCE
CREATE INDEX IDX_SETORES_CODIGO ON SETORES(CODIGO_SETOR);
CREATE INDEX IDX_SETORES_NOME ON SETORES(NOME_SETOR);
CREATE INDEX IDX_SETORES_ATIVO ON SETORES(ATIVO);
CREATE INDEX IDX_SETORES_CIDADE ON SETORES(CIDADE);

-- 4. CRIAR TRIGGER PARA ATUALIZAR DATA_ATUALIZACAO
CREATE OR REPLACE TRIGGER TRG_SETORES_UPDATE_DATE
    BEFORE UPDATE ON SETORES
    FOR EACH ROW
BEGIN
    :NEW.DATA_ATUALIZACAO := CURRENT_TIMESTAMP;
END;
/

-- 5. ADICIONAR COMENTÁRIOS NAS COLUNAS
COMMENT ON TABLE SETORES IS 'Tabela de setores do sistema de protocolo';
COMMENT ON COLUMN SETORES.ID IS 'Identificador único do setor';
COMMENT ON COLUMN SETORES.CODIGO_SETOR IS 'Código único do setor';
COMMENT ON COLUMN SETORES.NOME_SETOR IS 'Nome do setor';
COMMENT ON COLUMN SETORES.ORGAO IS 'Órgão ao qual o setor pertence';
COMMENT ON COLUMN SETORES.ATIVO IS 'Status do setor (S=Ativo, N=Inativo)';
COMMENT ON COLUMN SETORES.LOGRADOURO IS 'Endereço - logradouro';
COMMENT ON COLUMN SETORES.NUMERO IS 'Endereço - número';
COMMENT ON COLUMN SETORES.COMPLEMENTO IS 'Endereço - complemento';
COMMENT ON COLUMN SETORES.BAIRRO IS 'Endereço - bairro';
COMMENT ON COLUMN SETORES.CIDADE IS 'Endereço - cidade';
COMMENT ON COLUMN SETORES.ESTADO IS 'Endereço - estado (UF)';
COMMENT ON COLUMN SETORES.CEP IS 'Endereço - CEP';
COMMENT ON COLUMN SETORES.TELEFONE IS 'Telefone de contato';
COMMENT ON COLUMN SETORES.EMAIL IS 'Email de contato';
COMMENT ON COLUMN SETORES.DATA_CRIACAO IS 'Data de criação do registro';
COMMENT ON COLUMN SETORES.DATA_ATUALIZACAO IS 'Data da última atualização';
COMMENT ON COLUMN SETORES.LATITUDE IS 'Coordenada geográfica - latitude';
COMMENT ON COLUMN SETORES.LONGITUDE IS 'Coordenada geográfica - longitude';

-- 6. INSERIR ALGUNS DADOS DE EXEMPLO
INSERT INTO SETORES (CODIGO_SETOR, NOME_SETOR, ORGAO, ATIVO, CIDADE, ESTADO) VALUES 
('001', 'Setor Administrativo', 'SEFAZ-TO', 'S', 'Palmas', 'TO');

INSERT INTO SETORES (CODIGO_SETOR, NOME_SETOR, ORGAO, ATIVO, CIDADE, ESTADO) VALUES 
('002', 'Setor Fiscal', 'SEFAZ-TO', 'S', 'Palmas', 'TO');

INSERT INTO SETORES (CODIGO_SETOR, NOME_SETOR, ORGAO, ATIVO, CIDADE, ESTADO) VALUES 
('003', 'Setor Jurídico', 'SEFAZ-TO', 'S', 'Palmas', 'TO');

-- 7. CONFIRMAR ALTERAÇÕES
COMMIT;

-- 8. VERIFICAR A ESTRUTURA CRIADA
SELECT 'ESTRUTURA DA TABELA SETORES:' AS INFO FROM DUAL;
SELECT COLUMN_NAME, DATA_TYPE, DATA_LENGTH, NULLABLE 
FROM USER_TAB_COLUMNS 
WHERE TABLE_NAME = 'SETORES' 
ORDER BY COLUMN_ID;

SELECT 'TOTAL DE REGISTROS:' AS INFO FROM DUAL;
SELECT COUNT(*) AS TOTAL_REGISTROS FROM SETORES;

SELECT 'TABELA RECRIADA COM SUCESSO!' AS INFO FROM DUAL;