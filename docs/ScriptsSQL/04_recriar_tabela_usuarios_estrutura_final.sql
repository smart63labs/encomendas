-- =====================================================
-- SCRIPT: Recriar Tabela USUARIOS com Estrutura Final
-- DATA: 14/10/2025
-- DESCRIÇÃO: Recria a tabela USUARIOS com a estrutura 
--           e ordem de colunas exatas especificadas
-- =====================================================

-- 1. FAZER BACKUP DOS DADOS EXISTENTES
CREATE TABLE USUARIOS_BACKUP AS SELECT * FROM USUARIOS;

-- 2. REMOVER A TABELA ATUAL
DROP TABLE USUARIOS CASCADE CONSTRAINTS;

-- 3. CRIAR A TABELA COM A ESTRUTURA CORRETA
CREATE TABLE USUARIOS (
    ID NUMBER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    SETOR_ID NUMBER,
    ROLE VARCHAR2(50) DEFAULT 'USER' NOT NULL,
    SENHA VARCHAR2(255) NOT NULL,
    USUARIO_ATIVO CHAR(1) DEFAULT 'S' CHECK (USUARIO_ATIVO IN ('S', 'N')),
    ULTIMO_LOGIN TIMESTAMP,
    TENTATIVAS_LOGIN NUMBER DEFAULT 0,
    DATA_CRIACAO TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    DATA_ATUALIZACAO TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    BLOQUEADO_ATE TIMESTAMP,
    NOME VARCHAR2(255) NOT NULL,
    MATRICULA VARCHAR2(20),
    VINCULO_FUNCIONAL VARCHAR2(100),
    CPF VARCHAR2(14),
    "PIS/PASEP" VARCHAR2(15),
    SEXO VARCHAR2(1) CHECK (SEXO IN ('M', 'F')),
    ESTADO_CIVIL VARCHAR2(20),
    DATA_NASCIMENTO DATE,
    PAI VARCHAR2(255),
    MAE VARCHAR2(255),
    RG VARCHAR2(20),
    TIPO_RG VARCHAR2(50),
    ORGAO_EXPEDITOR VARCHAR2(50),
    UF_RG VARCHAR2(2),
    EXPEDICAO_RG DATE,
    CIDADE_NASCIMENTO VARCHAR2(100),
    UF_NASCIMENTO VARCHAR2(2),
    TIPO_SANGUINEO VARCHAR2(5),
    RACA_COR VARCHAR2(50),
    PNE VARCHAR2(1) CHECK (PNE IN ('S', 'N')),
    TIPO_VINCULO VARCHAR2(100),
    CATEGORIA VARCHAR2(100),
    REGIME_JURIDICO VARCHAR2(100),
    REGIME_PREVIDENCIARIO VARCHAR2(100),
    EVENTO_TIPO VARCHAR2(100),
    FORMA_PROVIMENTO VARCHAR2(100),
    CODIGO_CARGO VARCHAR2(20),
    CARGO VARCHAR2(255),
    ESCOLARIDADE_CARGO VARCHAR2(100),
    ESCOLARIDADE_SERVIDOR VARCHAR2(100),
    FORMACAO_PROFISSIONAL_1 VARCHAR2(255),
    FORMACAO_PROFISSIONAL_2 VARCHAR2(255),
    JORNADA VARCHAR2(50),
    NIVEL_REFERENCIA VARCHAR2(20),
    "COMISSAO_FUNÇAO" VARCHAR2(255),
    DATA_INI_COMISSAO DATE,
    TELEFONE VARCHAR2(20),
    ENDERECO VARCHAR2(255),
    NUMERO_ENDERECO VARCHAR2(10),
    COMPLEMENTO_ENDERECO VARCHAR2(100),
    BAIRRO_ENDERECO VARCHAR2(100),
    CIDADE_ENDERECO VARCHAR2(100),
    UF_ENDERECO VARCHAR2(2),
    CEP_ENDERECO VARCHAR2(10),
    E_MAIL VARCHAR2(255)
);

-- 4. CRIAR ÍNDICES
CREATE INDEX IDX_USUARIOS_SETOR_ID ON USUARIOS(SETOR_ID);
CREATE INDEX IDX_USUARIOS_CPF ON USUARIOS(CPF);
CREATE INDEX IDX_USUARIOS_MATRICULA ON USUARIOS(MATRICULA);
CREATE INDEX IDX_USUARIOS_EMAIL ON USUARIOS(E_MAIL);
CREATE INDEX IDX_USUARIOS_ROLE ON USUARIOS(ROLE);
CREATE INDEX IDX_USUARIOS_ATIVO ON USUARIOS(USUARIO_ATIVO);

-- 5. CRIAR FOREIGN KEY PARA SETORES
ALTER TABLE USUARIOS ADD CONSTRAINT FK_USUARIOS_SETOR 
    FOREIGN KEY (SETOR_ID) REFERENCES SETORES(ID);

-- 6. CRIAR TRIGGER PARA ATUALIZAR DATA_ATUALIZACAO
CREATE OR REPLACE TRIGGER TRG_USUARIOS_UPDATE_DATE
    BEFORE UPDATE ON USUARIOS
    FOR EACH ROW
BEGIN
    :NEW.DATA_ATUALIZACAO := CURRENT_TIMESTAMP;
END;
/

-- 7. MIGRAR DADOS DO BACKUP (ADAPTANDO PARA A NOVA ESTRUTURA)
INSERT INTO USUARIOS (
    SETOR_ID,
    ROLE,
    SENHA,
    USUARIO_ATIVO,
    ULTIMO_LOGIN,
    TENTATIVAS_LOGIN,
    DATA_CRIACAO,
    DATA_ATUALIZACAO,
    BLOQUEADO_ATE,
    NOME,
    MATRICULA,
    VINCULO_FUNCIONAL,
    CPF,
    "PIS/PASEP",
    SEXO,
    ESTADO_CIVIL,
    DATA_NASCIMENTO,
    PAI,
    MAE,
    RG,
    TIPO_RG,
    ORGAO_EXPEDITOR,
    UF_RG,
    EXPEDICAO_RG,
    CIDADE_NASCIMENTO,
    UF_NASCIMENTO,
    TIPO_SANGUINEO,
    RACA_COR,
    PNE,
    TIPO_VINCULO,
    CATEGORIA,
    REGIME_JURIDICO,
    REGIME_PREVIDENCIARIO,
    EVENTO_TIPO,
    FORMA_PROVIMENTO,
    CODIGO_CARGO,
    CARGO,
    ESCOLARIDADE_CARGO,
    ESCOLARIDADE_SERVIDOR,
    FORMACAO_PROFISSIONAL_1,
    FORMACAO_PROFISSIONAL_2,
    JORNADA,
    NIVEL_REFERENCIA,
    "COMISSAO_FUNÇAO",
    DATA_INI_COMISSAO,
    TELEFONE,
    ENDERECO,
    NUMERO_ENDERECO,
    COMPLEMENTO_ENDERECO,
    BAIRRO_ENDERECO,
    CIDADE_ENDERECO,
    UF_ENDERECO,
    CEP_ENDERECO,
    E_MAIL
)
SELECT 
    SETOR_ID,
    NVL(ROLE, 'USER'),
    SENHA,
    NVL(USUARIO_ATIVO, 'S'),
    ULTIMO_LOGIN,
    NVL(TENTATIVAS_LOGIN, 0),
    NVL(DATA_CRIACAO, CURRENT_TIMESTAMP),
    NVL(DATA_ATUALIZACAO, CURRENT_TIMESTAMP),
    BLOQUEADO_ATE,
    NOME,
    MATRICULA,
    VINCULO_FUNCIONAL,
    CPF,
    "PIS/PASEP",
    SEXO,
    ESTADO_CIVIL,
    DATA_NASCIMENTO,
    PAI,
    MAE,
    RG,
    TIPO_RG,
    ORGAO_EXPEDITOR,
    UF_RG,
    EXPEDICAO_RG,
    CIDADE_NASCIMENTO,
    UF_NASCIMENTO,
    TIPO_SANGUINEO,
    RACA_COR,
    PNE,
    TIPO_VINCULO,
    CATEGORIA,
    REGIME_JURIDICO,
    REGIME_PREVIDENCIARIO,
    EVENTO_TIPO,
    FORMA_PROVIMENTO,
    CODIGO_CARGO,
    CARGO,
    ESCOLARIDADE_CARGO,
    ESCOLARIDADE_SERVIDOR,
    FORMACAO_PROFISSIONAL_1,
    FORMACAO_PROFISSIONAL_2,
    JORNADA,
    NIVEL_REFERENCIA,
    "COMISSAO_FUNÇAO",
    DATA_INI_COMISSAO,
    TELEFONE,
    ENDERECO,
    NUMERO_ENDERECO,
    COMPLEMENTO_ENDERECO,
    BAIRRO_ENDERECO,
    CIDADE_ENDERECO,
    UF_ENDERECO,
    CEP_ENDERECO,
    E_MAIL
FROM USUARIOS_BACKUP
WHERE NOME IS NOT NULL;

-- 8. VERIFICAR A ESTRUTURA FINAL
SELECT COLUMN_NAME, DATA_TYPE, DATA_LENGTH, NULLABLE, COLUMN_ID
FROM USER_TAB_COLUMNS 
WHERE TABLE_NAME = 'USUARIOS'
ORDER BY COLUMN_ID;

-- 9. VERIFICAR DADOS MIGRADOS
SELECT COUNT(*) AS TOTAL_USUARIOS FROM USUARIOS;
SELECT COUNT(*) AS TOTAL_BACKUP FROM USUARIOS_BACKUP;

-- 10. COMENTÁRIOS SOBRE A ESTRUTURA
COMMENT ON TABLE USUARIOS IS 'Tabela de usuários do sistema com estrutura final definida';
COMMENT ON COLUMN USUARIOS.ID IS 'Identificador único do usuário';
COMMENT ON COLUMN USUARIOS.SETOR_ID IS 'Referência ao setor do usuário';
COMMENT ON COLUMN USUARIOS.ROLE IS 'Perfil/papel do usuário no sistema';
COMMENT ON COLUMN USUARIOS.SENHA IS 'Senha criptografada do usuário';
COMMENT ON COLUMN USUARIOS.USUARIO_ATIVO IS 'Indica se o usuário está ativo (S/N)';
COMMENT ON COLUMN USUARIOS.E_MAIL IS 'Email do usuário';

COMMIT;

-- SCRIPT FINALIZADO COM SUCESSO
SELECT 'Tabela USUARIOS recriada com sucesso!' AS STATUS FROM DUAL;