-- Script para reestruturação da tabela USUARIOS
-- Data: 2025-01-10
-- Descrição: Reestruturação completa da tabela usuarios com novos campos

-- 1. Fazer backup da tabela atual
CREATE TABLE USUARIOS_BACKUP AS SELECT * FROM USUARIOS;

-- 2. Dropar a tabela atual
DROP TABLE USUARIOS CASCADE CONSTRAINTS;

-- 3. Criar a nova tabela com a estrutura completa
CREATE TABLE USUARIOS (
    -- Campos principais do sistema
    ID NUMBER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    SETOR_ID NUMBER(10) REFERENCES SETORES(ID),
    ROLE VARCHAR2(10) DEFAULT 'USER' CHECK (ROLE IN ('ADMIN', 'USER')),
    SENHA VARCHAR2(255) NOT NULL, -- Será hasheada, mas validação de 8 chars com maiúscula e especial no frontend
    TENTATIVAS_LOGIN NUMBER DEFAULT 0,
    DATA_CRIACAO TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    DATA_ATUALIZACAO TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    BLOQUEADO_ATE TIMESTAMP,
    
    -- Dados pessoais básicos
    NOME VARCHAR2(255) NOT NULL,
    MATRICULA NUMBER(10),
    VINCULO_FUNCIONAL NUMBER(4) CHECK (VINCULO_FUNCIONAL BETWEEN 10 AND 9999),
    CPF NUMBER(11) UNIQUE,
    PIS_PASEP NUMBER(11),
    SEXO CHAR(1) CHECK (SEXO IN ('M', 'F')),
    ESTADO_CIVIL VARCHAR2(50),
    DATA_NASCIMENTO DATE,
    PAI VARCHAR2(255),
    MAE VARCHAR2(255),
    
    -- Documentos
    RG VARCHAR2(20),
    TIPO_RG VARCHAR2(50),
    ORGAO_EXPEDITOR VARCHAR2(100),
    UF_RG CHAR(2),
    EXPEDICAO_RG DATE,
    
    -- Dados de nascimento
    CIDADE_NASCIMENTO VARCHAR2(100),
    UF_NASCIMENTO CHAR(2),
    
    -- Dados complementares
    TIPO_SANGUINEO VARCHAR2(5),
    RACA_COR VARCHAR2(50),
    PNE CHAR(1) DEFAULT 'N' CHECK (PNE IN ('S', 'N')),
    
    -- Dados funcionais
    TIPO_VINCULO VARCHAR2(100),
    CATEGORIA VARCHAR2(100),
    REGIME_JURIDICO VARCHAR2(100),
    REGIME_PREVIDENCIARIO VARCHAR2(100),
    EVENTO_TIPO VARCHAR2(100),
    FORMA_PROVIMENTO VARCHAR2(100),
    CODIGO_CARGO VARCHAR2(20),
    CARGO VARCHAR2(200),
    ESCOLARIDADE_CARGO VARCHAR2(100),
    ESCOLARIDADE_SERVIDOR VARCHAR2(100),
    FORMACAO_PROFISSIONAL_1 VARCHAR2(200),
    FORMACAO_PROFISSIONAL_2 VARCHAR2(200),
    JORNADA VARCHAR2(50),
    NIVEL_REFERENCIA VARCHAR2(20),
    COMISSAO_FUNCAO VARCHAR2(200),
    DATA_INI_COMISSAO DATE,
    
    -- Dados de contato e endereço
    TELEFONE VARCHAR2(20),
    ENDERECO VARCHAR2(255),
    NUMERO_ENDERECO VARCHAR2(10),
    COMPLEMENTO_ENDERECO VARCHAR2(100),
    BAIRRO_ENDERECO VARCHAR2(100),
    CIDADE_ENDERECO VARCHAR2(100),
    UF_ENDERECO CHAR(2),
    CEP_ENDERECO VARCHAR2(9),
    E_MAIL VARCHAR2(255) UNIQUE NOT NULL,
    
    -- Campos de controle (mantidos da estrutura anterior)
    IS_ACTIVE NUMBER(1) DEFAULT 1 CHECK (IS_ACTIVE IN (0, 1)),
    LAST_LOGIN TIMESTAMP
);

-- 4. Criar índices para melhor performance
CREATE INDEX IDX_USUARIOS_EMAIL ON USUARIOS(E_MAIL);
CREATE INDEX IDX_USUARIOS_CPF ON USUARIOS(CPF);
CREATE INDEX IDX_USUARIOS_MATRICULA ON USUARIOS(MATRICULA);
CREATE INDEX IDX_USUARIOS_SETOR ON USUARIOS(SETOR_ID);
CREATE INDEX IDX_USUARIOS_ROLE ON USUARIOS(ROLE);

-- 5. Criar trigger para atualizar DATA_ATUALIZACAO automaticamente
CREATE OR REPLACE TRIGGER TRG_USUARIOS_UPDATE_DATE
    BEFORE UPDATE ON USUARIOS
    FOR EACH ROW
BEGIN
    :NEW.DATA_ATUALIZACAO := CURRENT_TIMESTAMP;
END;
/

-- 6. Migrar dados da tabela backup (apenas os campos compatíveis)
INSERT INTO USUARIOS (
    E_MAIL,
    SENHA,
    NOME,
    ROLE,
    TELEFONE,
    IS_ACTIVE,
    DATA_CRIACAO,
    DATA_ATUALIZACAO,
    LAST_LOGIN,
    SETOR_ID,
    MATRICULA,
    VINCULO_FUNCIONAL,
    CPF,
    TENTATIVAS_LOGIN,
    BLOQUEADO_ATE
)
SELECT 
    EMAIL,
    PASSWORD_HASH,
    NAME,
    CASE 
        WHEN UPPER(ROLE) = 'ADMIN' THEN 'ADMIN'
        ELSE 'USER'
    END,
    PHONE,
    IS_ACTIVE,
    CREATED_AT,
    UPDATED_AT,
    LAST_LOGIN,
    SETOR_ID,
    CASE 
        WHEN MATRICULA IS NOT NULL AND REGEXP_LIKE(MATRICULA, '^[0-9]+$') 
        THEN TO_NUMBER(MATRICULA)
        ELSE NULL
    END,
    CASE 
        WHEN VINCULO_FUNCIONAL IS NOT NULL AND REGEXP_LIKE(VINCULO_FUNCIONAL, '^[0-9]+$') 
        THEN TO_NUMBER(VINCULO_FUNCIONAL)
        ELSE NULL
    END,
    CASE 
        WHEN CPF IS NOT NULL AND REGEXP_LIKE(REPLACE(REPLACE(REPLACE(CPF, '.', ''), '-', ''), '/', ''), '^[0-9]{11}$') 
        THEN TO_NUMBER(REPLACE(REPLACE(REPLACE(CPF, '.', ''), '-', ''), '/', ''))
        ELSE NULL
    END,
    TENTATIVAS_LOGIN,
    BLOQUEADO_ATE
FROM USUARIOS_BACKUP;

-- 7. Inserir usuário admin padrão se não existir
MERGE INTO USUARIOS u
USING (SELECT 'admin_protocolo@sefaz.to.gov.br' as email FROM dual) d
ON (u.E_MAIL = d.email)
WHEN NOT MATCHED THEN
INSERT (
    E_MAIL,
    SENHA,
    NOME,
    ROLE,
    IS_ACTIVE,
    DATA_CRIACAO,
    DATA_ATUALIZACAO
) VALUES (
    'admin_protocolo@sefaz.to.gov.br',
    '$2b$10$92IXUNpkjO0rOQ5byMi.Ye4oKoEa3Ro9llC/.og/at2.uheWG/igi', -- senha: admin123
    'Administrador do Sistema',
    'ADMIN',
    1,
    CURRENT_TIMESTAMP,
    CURRENT_TIMESTAMP
);

-- 8. Gerar senha padrão para usuários sem senha (Protocolo1!)
UPDATE USUARIOS 
SET SENHA = '$2b$10$vI8aWBnW3fID.ZQ4/zo1G.q1lRps.9cGLcZEiGDMVr5yUP1KUOYTa' -- Protocolo1!
WHERE SENHA IS NULL OR SENHA = '';

-- 9. Comentários nas colunas para documentação
COMMENT ON TABLE USUARIOS IS 'Tabela de usuários do sistema de protocolo digital';
COMMENT ON COLUMN USUARIOS.ID IS 'Identificador único do usuário';
COMMENT ON COLUMN USUARIOS.SETOR_ID IS 'Referência ao setor do usuário';
COMMENT ON COLUMN USUARIOS.ROLE IS 'Perfil do usuário: ADMIN ou USER';
COMMENT ON COLUMN USUARIOS.SENHA IS 'Hash da senha do usuário (máx 8 chars, 1 maiúscula, 1 especial)';
COMMENT ON COLUMN USUARIOS.TENTATIVAS_LOGIN IS 'Contador de tentativas de login falhadas';
COMMENT ON COLUMN USUARIOS.BLOQUEADO_ATE IS 'Data/hora até quando o usuário está bloqueado';
COMMENT ON COLUMN USUARIOS.CPF IS 'CPF do usuário (apenas números)';
COMMENT ON COLUMN USUARIOS.PIS_PASEP IS 'Número PIS/PASEP do usuário';
COMMENT ON COLUMN USUARIOS.VINCULO_FUNCIONAL IS 'Código do vínculo funcional (2-4 dígitos)';
COMMENT ON COLUMN USUARIOS.PNE IS 'Portador de Necessidades Especiais (S/N)';

-- 10. Verificar a estrutura criada
SELECT 'Tabela USUARIOS reestruturada com sucesso!' as STATUS FROM dual;
SELECT COUNT(*) as TOTAL_USUARIOS FROM USUARIOS;

COMMIT;